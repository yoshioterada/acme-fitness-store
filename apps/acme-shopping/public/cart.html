<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="robots" content="all,follow">
    <meta name="googlebot" content="index,follow,snippet,archive">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ACME Fitness</title>
    <meta name="keywords" content="">
    <!-- Bootstrap CSS-->
    <link rel="stylesheet" href="vendor/bootstrap/css/bootstrap.min.css">
    <!-- Google fonts - Montserrat and Merriweather-->
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700|Merriweather:400,400italic" rel="stylesheet"
          type="text/css">
    <!-- Font Awesome css-->
    <link rel="stylesheet" href="vendor/font-awesome/css/font-awesome.min.css">
    <!-- Owl Carousel-->
    <link rel="stylesheet" href="vendor/owl.carousel/assets/owl.carousel.min.css">
    <link rel="stylesheet" href="vendor/owl.carousel/assets/owl.theme.default.min.css">
    <!-- Theme stylesheet-->
    <link id="theme-stylesheet" href="css/style.default.css" rel="stylesheet">
    <!-- Custom stylesheet - for your changes-->
    <link href="css/custom.css" rel="stylesheet">
    <!-- Tweaks for older IEs--><!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script><![endif]-->
    <!-- Favicon-->
    <link rel="shortcut icon" href="favicon.png">
</head>
<body>
<!-- *** NAVBAR *** -->
<nav id="navbar" role="navigation" class="navbar navbar-light fixed-top navbar-expand-lg yamm justify-content-between">
</nav>
<!-- /#navbar-->
<!-- *** NAVBAR END ***-->
<!--  *** LOGIN MODAL ***-->
<div tabindex="-1" role="dialog" class="modal">
    <div role="document" class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Modal title</h5>
                <button type="button" data-dismiss="modal" aria-label="Close" class="close"><span
                        aria-hidden="true">×</span></button>
            </div>
            <div class="modal-body">
                <p>Modal body text goes here.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary">Save changes</button>
                <button type="button" data-dismiss="modal" class="btn btn-secondary">Close</button>
            </div>
        </div>
    </div>
</div>
<div id="login-modal" tabindex="-1" role="dialog" aria-labelledby="Login" aria-hidden="true" class="modal fade">
</div>
<!-- *** LOGIN MODAL END ***-->
<div id="all">
    <div id="content">
        <div class="container">
            <ul class="breadcrumb justify-content-md-end justify-content-center">
                <li class="breadcrumb-item"><a href="index.html">Home</a></li>
                <li class="breadcrumb-item active">ショッピングカート</li>
            </ul>
            <div class="box text-center">
                <div class="row">
                    <div class="col-md-10 offset-md-1">
                        <h1>カート内の商品一覧</h1>
                        <p class="text-muted"><strong id="cartText"></strong></p>
                    </div>
                </div>
            </div>
            <div class="row">
                <div id="basket" class="col-lg-9">
                    <div class="box">
                        <form method="get" action="checkout1.html">
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                    <tr>
                                        <th colspan="2">商品</th>
                                        <th>数量</th>
                                        <th>価格</th>
                                        <th>割引</th>
                                        <th colspan="2">小計</th>
                                    </tr>
                                    </thead>
                                    <tbody id="cartList">
                                    </tbody>
                                    <tfoot>
                                    <tr>
                                        <th colspan="5">合計</th>
                                        <th id="cartTotal" colspan="2"></th>
                                    </tr>
                                    </tfoot>
                                </table>
                            </div>
                            <!-- /.table-responsive-->
                            <div class="box-footer">
                                <div class="pull-left"><a href="catalog.html" class="btn btn-outline-white-secondary"><i
                                        class="fa fa-chevron-left"></i>買い物を続ける</a></div>
                                <div class="pull-right">
                                    <!---<button id="updateCart" class="btn btn-outline-white-secondary"><i class="fa fa-refresh"></i> Update cart</button>-->
                                    <button type="submit" class="btn btn-outline-white-primary">チェックアウトに進む<i
                                            class="fa fa-chevron-right"></i></button>
                                </div>
                            </div>
                        </form>
                    </div>
                    <!-- /.box-->
                </div>
                <!-- /.col-lg-9-->
                <div class="col-lg-3">
                    <div id="order-summary" class="box">
                        <div class="box-header">
                            <h3>注文概要</h3>
                        </div>
                        <p class="text-muted">送料や手数料は、購入金額の合計に基づいて計算されます。</p>
                        <div class="table-responsive">
                            <table class="table">
                                <tbody>
                                <tr>
                                    <td>注文小計</td>
                                    <th id="orderSubtotal"></th>
                                </tr>
                                <tr>
                                    <td>送料と手数料</td>
                                    <th id="shipping">無料</th>
                                </tr>
                                <tr>
                                    <td>税金</td>
                                    <th>0.00</th>
                                </tr>
                                <tr class="total">
                                    <td>合計</td>
                                    <th id="orderTotal"></th>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="box">
                        <div class="box-header">
                            <h4>クーポン・コード</h4>
                        </div>
                        <p class="text-muted">クーポンコードをお持ちの方は、下のボックスにご入力ください。</p>
                        <form>
                            <div class="input-group">
                                <input type="text" class="form-control">
                                <div class="input-group-append">
                                    <button type="button" class="btn btn-outline-primary"><i class="fa fa-gift"></i>
                                    </button>
                                </div>
                            </div>
                            <!-- /input-group-->
                        </form>
                    </div>
                </div>
                <!-- /.col-lg-3-->
            </div>
        </div>
    </div>
    <!-- *** FOOTER ***-->
    <div id="footer">
    </div>
    <!-- /#footer-->
    <!-- *** FOOTER END ***-->
</div>
<!-- #### JavaScript files ###-->
<script src="vendor/jquery/jquery.min.js"></script>
<script src="vendor/popper.js/umd/popper.min.js"></script>
<script src="vendor/bootstrap/js/bootstrap.min.js"></script>
<script src="vendor/jquery.cookie/jquery.cookie.js"></script>
<script src="vendor/owl.carousel/owl.carousel.min.js"></script>
<!-- main script-->
<script src="js/front.js"></script>
<script src="js/client.js"></script>
<script src="js/jwt-decode.min.js"></script>
<script>
    $(document).ready(function () {
        $.ajaxSetup({
            contentType: "application/json; charset=utf-8"
        });

        $("#navbar").load("navbar.html")
        $("#login-modal").load("login.html")
        $("#footer").load("footer.html")

        // Check if the user is logged in
        var userid = getUserID();

        $.ajax({

            url: "/cart/items/" + userid,
            type: "GET",
            success: function (body, textStatus, jqXHR) {
                console.log("status cart is " + jqXHR.status)
                if (jqXHR.status == 200) {

                    if (body != null) {

                        var content = ''
                        var cartTotal = 0;
                        var quantity = 0;
                        var imageUrl1 = ''

                        $.each(body.cart, function (index, item) {

                            image = getImageUrl(item.itemid, function (imageurl) {
                                return imageurl;
                            });

                            content += '<tr id="' + item.itemid + '">\
                                <td>\
                                  <a href="detail.html?id=' + item.itemid + '"' + '><img src=' + image + ' alt=""' + '></a>\
                                </td>\
                                <td><a href="detail.html?id=' + item.itemid + '">' + item.name + '</a></td>\
                                <td>\
                                    <input type="number" min=1 value="' + item.quantity + '" class="form-control" style="width: 4em;">\
                                </td>\
                                <td>' + item.price + '</td>\
                                <td>￥0</td>\
                                <td>' + (Intl.NumberFormat('ja-JP').format((subTotalFunc(item)))) + '</td>\
                                <td>\
                                  <a href="#"><i class="fa fa-trash-o"></i></a>\
                                </td>\
                            </tr>'

                            quantity += item.quantity;
                        });

                        function subTotalFunc(item) {
                            var stotal = item.price.replace('￥','').replace(',','') * item.quantity;
                            cartTotal += parseInt(stotal);
                            return stotal;
                        }
                        sessionStorage.setItem('total', cartTotal)

                        // cartTotal = getCartTotal(userid, function (total) {
                        //     return total;
                        // });

                        $("#cartText").text('現在、カートに ' + quantity + ' 個の商品があります')
                        $('#cartList').append(content);
                        $("#cartTotal").text('￥' + Intl.NumberFormat('ja-JP').format(cartTotal))

                        $("#orderSubtotal").text(Intl.NumberFormat('ja-JP').format(cartTotal))
                        $("#orderTotal").text('￥' + Intl.NumberFormat('ja-JP').format(cartTotal))
                    }
                } else {

                    console.log('status : ' + jqXHR.status)

                }
            },
            error: function (jqXHR, textStatus, errorThrown) {

                console.log(errorThrown)
                window.location.href = "/Unauthorized.html"
            }
        });


        $('#cartList').on('click', 'td i', function (e) {

            var itemid = $(this).parents('tr').attr('id')
            deleteItem(itemid, userid)
        });

        $('#cartList').on('click', 'td input', function (e) {

            var itemid = $(this).parents('tr').attr('id')
            var val = $(this).val()
            // Convert string to int
            val = parseInt(val, 10)
            updateCart(itemid, val, userid)
        });


    }) // End of script
</script>
</body>
</html>